<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="author" content="Kaiwen Tsou">  
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kaiwen Tsou Software Developer Portfolio XMLRequests Experiments</title>
    <!-- <link href="../css/main.css" rel="stylesheet"> -->

    <style> 
        fieldset{
            display:flex;
            flex-direction: column;
        }

        fieldset > *{
            padding: 1vh;
        }

        output {
            white-space: pre;
        }
    </style>
</head>
<body>
    <form name="article">
        <legend> HW5 Part 1 Methods Experiments </legend>  
        <fieldset >
            <label for="id"> id(number):
                <input type="text" name="id" id="id" />
            </label>
            <label for="article_name "> article_name:
                <input type="text" name="article_name " id="article_name" />
            </label>
            <label for="article_body "> article_body:
                <textarea name="article_body" id="article_body"></textarea>
            </label>
            <label for="date"> date:
                <!-- TODO Gray out (to show non-editable) -->
                <input type="text" name="date" id="date" readonly="readonly" ></textarea>
            </label>

            <button type="button" id="postBtn">POST</button>
            <button type="button" id="getBtn">GET</button>
            <button type="button" id="putBtn">PUT</button>
            <button type="button" id="deleteBtn">DELETE</button>
        </fieldset>
    </form>

    <output>

    </output>

    <script>

        // TODO Reorganize code

        let date = new Date();
        let cur_date = `${date.getMonth()}/${date.getDate()}/${date.getFullYear()}`;
        let date_field = document.querySelector('input[id=date]');

        //set date on first load
        date_field.value = cur_date;

        
        // Referenced basic AJAX example from MDN https://developer.mozilla.org/en-US/docs/Web/Guide/AJAX
    let httpRequest;
    let article_id;
    let form_data;

        document.getElementById("postBtn").addEventListener('click', post_request);
        document.getElementById("getBtn").addEventListener('click', get_request);
        document.getElementById("putBtn").addEventListener('click', put_request);
        document.getElementById("deleteBtn").addEventListener('click', delete_request);

        function post_request() {
            init_request();
            if (!httpRequest) {
                alert('Giving up :( Cannot create an XMLHTTP instance');
                return false;
            }
            httpRequest.open('POST', 'https://httpbin.org/post');
            httpRequest.setRequestHeader('Content-type', 'application/json; charset=utf-8');
            //Note, Object.fromEntries is not compatible with IE
            httpRequest.send(JSON.stringify(Object.fromEntries(form_data.entries())));
        }

        function get_request() {
            init_request();
            if (!httpRequest) {
                alert('Giving up :( Cannot create an XMLHTTP instance');
                return false;
            }
            httpRequest.open('GET', `https://httpbin.org/get?id=${article_id}`);
            httpRequest.send();
        }

        function put_request() {
            init_request();
            if (!httpRequest) {
                alert('Giving up :( Cannot create an XMLHTTP instance');
                return false;
            }
            httpRequest.open('PUT', `https://httpbin.org/put?id=${article_id}`);
            httpRequest.setRequestHeader('Content-type', 'application/json; charset=utf-8');
            //Note, Object.fromEntries is not compatible with IE
            httpRequest.send(JSON.stringify(Object.fromEntries(form_data.entries())));
        }

        function delete_request() {
            init_request();
            if (!httpRequest) {
                alert('Giving up :( Cannot create an XMLHTTP instance');
                return false;
            }
            httpRequest.open('DELETE', `https://httpbin.org/delete?id=${article_id}`);
            httpRequest.send();
        }

        function draw_contents() {
            if (httpRequest.readyState === XMLHttpRequest.DONE) {
                if (httpRequest.status === 200) {
                    let table = document.createElement("table");
                    document.querySelector("output").innerText=JSON.stringify(httpRequest.response, null, 4);
                } else {
                    alert('There was a problem with the request.');
                }
            }
        }

        /**
         * Initialize some values for new request
         */
        function init_request() {
            httpRequest = new XMLHttpRequest();
            form_data = new FormData(document.forms.article);
            //update date field in case a user does something at 11:59PM I guess
            //pass updated date in directly to prevent users from editing date in devTools and then submitting
            cur_date = `${date.getMonth()}/${date.getDate()}/${date.getFullYear()}`;
            date_field.value = cur_date;
            article_id = document.querySelector('form #id').value;
            httpRequest.onreadystatechange = draw_contents;
            httpRequest.responseType = 'json'; 
        }
    </script>
</body>